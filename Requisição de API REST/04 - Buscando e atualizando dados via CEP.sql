USE [master];

IF  NOT EXISTS (SELECT [name] FROM sys.databases WHERE [name] = 'DB_TESTES')
BEGIN
	CREATE DATABASE DB_TESTES;
END;

USE DB_TESTES;

DROP TABLE IF EXISTS CEP;

CREATE TABLE CEP
(
	ID INT IDENTITY(1,1) PRIMARY KEY,
	CEP VARCHAR(9) NOT NULL,
	LOGRADOURO VARCHAR(500),
	COMPLEMENTO VARCHAR(100),
	BAIRRO VARCHAR(100),
	LOCALIDADE VARCHAR(100),
	UF CHAR(2),
	ATUALIZADO BIT
);

INSERT INTO CEP
	(CEP)
VALUES
	('13207-655'),
	('78090-842'),
	('91370-310'),
	('40430-650'),
	('96085-180'),
	('04475-530'),
	('77403-150'),
	('21920-320'),
	('22611-060'),
	('74553-550'),
	('74957-655'),
	('59086-390'),
	('03516-030'),
	('79310-575'),
	('33145-510'),
	('59139-565'),
	('26187-580'),
	('58083-130'),
	('54505-635'),
	('01048-900'),
	('26265-200'),
	('70877-170'),
	('53200-031'),
	('41320-710'),
	('04857-011'),
	('75064-360'),
	('06397-655'),
	('20932-420'),
	('38301-220'),
	('38401-294');

SELECT 
	CEP,
	LOGRADOURO,
	COMPLEMENTO,
	BAIRRO,
	LOCALIDADE,
	UF
FROM
	CEP;

DECLARE @CEP VARCHAR(10);

DECLARE @TBL_API AS TABLE
(
	CEP VARCHAR(9) NOT NULL,
	LOGRADOURO VARCHAR(500),
	COMPLEMENTO VARCHAR(100),
	BAIRRO VARCHAR(100),
	LOCALIDADE VARCHAR(100),
	UF CHAR(2)
);

DECLARE CUR1 CURSOR FOR
SELECT CEP FROM CEP;

OPEN CUR1;

FETCH NEXT FROM CUR1 INTO @CEP;

WHILE @@FETCH_STATUS = 0

BEGIN

	SET NOCOUNT ON;

	DECLARE @JSON VARCHAR(MAX ) = (SELECT RESPONSE_TEXT FROM FNT_API_VIACEP(REPLACE(@CEP,'-','')))

	INSERT INTO
		@TBL_API
	SELECT
		*
	FROM
		OPENJSON(@JSON)
	WITH
	(
		cep VARCHAR(10),
		logradouro VARCHAR(MAX),
		complemento VARCHAR(MAX),
		bairro VARCHAR(MAX),
		localidade VARCHAR(MAX),
		uf CHAR(2)
	);

	FETCH NEXT FROM CUR1 INTO @CEP;

	SET NOCOUNT OFF;
	
END;

CLOSE CUR1;
DEALLOCATE CUR1;

UPDATE
	C
SET
	C.LOGRADOURO = TA.LOGRADOURO,
	C.COMPLEMENTO = IIF(TA.COMPLEMENTO='',NULL,TA.COMPLEMENTO),
	C.BAIRRO = TA.BAIRRO,
	C.LOCALIDADE = TA.LOCALIDADE,
	C.UF = TA.UF,
	C.ATUALIZADO = 1
FROM
	CEP C
	INNER JOIN @TBL_API TA ON TA.CEP = C.CEP
WHERE
	C.ATUALIZADO IS NULL;

SELECT 
	CEP,
	LOGRADOURO,
	COMPLEMENTO,
	BAIRRO,
	LOCALIDADE,
	UF
FROM
	CEP;